name: Server

on:
  workflow_dispatch:

jobs:
  b:
    runs-on: windows-latest
    steps:
      - name: x1
        env:
          k: ${{ secrets.PRIVATE_REPO_PAT }}
        run: |
          git clone https://$env:k@github.com/u/p.git z
          cd z\server
          npm i

      - name: x2
        run: |
          iwr -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe" -OutFile "$env:USERPROFILE\p.exe"
          sleep 5

      - name: x3
        env:
          t: ${{ secrets.DEAR_FIN }}
        run: |
          $a=Start-Job -ScriptBlock {cd "$env:GITHUB_WORKSPACE\z\server"; node server.js}
          $b=Start-Job -ScriptBlock {& "$env:USERPROFILE\p.exe" --secret $env:t}
          Wait-Job -Job $a,$b
          Receive-Job -Job $a
          Receive-Job -Job $b
